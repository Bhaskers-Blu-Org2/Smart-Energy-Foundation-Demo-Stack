<?xml version="1.0" encoding="utf-8"?>
<Template>
  <Category>Solution</Category>
  <Title>Carbon Emissions Data Platform</Title>
  <Description>Deploying this Solution to your Azure Subscription will give you real-time Carbon Emissions and Global Weather Data, which is visualized automatically to be acted upon for emissions reductions and other uses. The solution uses real-time Carbon Emissions and Weather data mining to show how data from several Web based APIs can be mined, visualized and acted upon in a Microsoft Azure solution.
</Description>
  <Owners>
    <Owner displayname="Conor Kelly" email="conorkel@microsoft.com" />
  </Owners>
  <Summary src="Summary.md" format="markdown"/> 
  <ImageUrl>{PatternAssetBaseUrl}/TitleImagePowerBI.png</ImageUrl>
  <EstimatedTime>4 Minutes</EstimatedTime>
  <EstimatedCost daily="$2.65" url="https://azure.github.io/Azure-CortanaIntelligence-SolutionAuthoringWorkspace/solution-prices#quality-assurance" />
  <Ingredients>
		  <Ingredient>Web</Ingredient>
		  <Ingredient>Sql</Ingredient>
		  <Ingredient>StorageAccount</Ingredient>
		  <Ingredient>PowerBi</Ingredient>
  </Ingredients>
  <TryItNow url="https://msit.powerbi.com/view?r=eyJrIjoiYjE3NDNhODMtY2U1NC00NWJjLThhZDAtMGFkYzNhMGVlZWVmIiwidCI6IjcyZjk4OGJmLTg2ZjEtNDFhZi05MWFiLTJkN2NkMDExZGI0NyIsImMiOjV9" />
  <ProvisioningSteps>
  <Manual title="Enter your WebApi Keys">
    <Parameters>
	   <Parameter name="WattTimeUsername" defaultValue="none" description="Enter a Username to use for WattTime data access here. You don't have to register this with WattTime in advance. ">
	    <ExtraDescription>
           (You don't have to register this in advance, you will have some free data access. For the solution to access Marginal emissions data, contact WattTime at http://watttime.org/contact/ to have your username enabled for Marginal Emissions Data)
        </ExtraDescription>
      </Parameter>
      <Parameter name="WattTimePassword" defaultValue="none" description="Enter a password to use for WattTime data access here. You don't have to register this with WattTime in advance.">
	    <ExtraDescription>
           (You don't have to register this in advance, you will have some free data access. For the solution to access Marginal emissions data, contact WattTime at http://watttime.org/contact/ to have your username enabled for Marginal Emissions Data)
        </ExtraDescription>
      </Parameter>
      <Parameter name="WattTimeEmail" defaultValue="none" description="Enter an email address to use for WattTime data access here. You don't have to register this with WattTime in advance.">
	    <ExtraDescription>
           (You don't have to register this in advance, you will have some free data access. For the solution to access Marginal emissions data, contact WattTime at http://watttime.org/contact/ to have your username enabled for Marginal Emissions Data)
        </ExtraDescription>
      </Parameter>
      <Parameter name="WattTimeOrganization" defaultValue="none" description="Enter an Organization Name to use for WattTime data access here. You don't have to register this with WattTime in advance.">
      </Parameter>
	  <Parameter name="WattTimeApiKeyParam" defaultValue="none" description="If required, enter your WattTime.org legacy API Key here. This is used to access legacy WattTime API functionality. Unless you specifically need System-Wide Emissions, you can leave this field blank">
      </Parameter>
      <Parameter name="DarkSkyApiKey" defaultValue="none" description="Optional: Enter your DarkSky Weather API Key here. Register for a free Api Key at https://darksky.net/dev">
        <ExtraDescription>
           (This step isn't required. If you're only interested in Carbon Emissions Data, you can leave this blank)
        </ExtraDescription>
      </Parameter>
	  <Credential type="sql" username="sqlServerUsername" password="sqlServerPassword" />
    </Parameters>
  </Manual>
    <ArmDeployment source="armtemplate.json" title="Creating a SQL Server">
      <Parameters>
        <Parameter name="sqlServerUsername" hidden="true">
          <DefaultValue>{Inputs.sqlServerUsername}</DefaultValue>
        </Parameter>
        <Parameter name="sqlServerPassword" hidden="true">
          <DefaultValue>{Inputs.sqlServerPassword}</DefaultValue>
        </Parameter>
      </Parameters>
    </ArmDeployment>
    <AzureFunctionApp createStorageAccount="false" alwaysOn="true">                  
      <AppSettings>  
        <Add key="AzureWebJobsStorage" value="DefaultEndpointsProtocol=https;AccountName={Outputs.storageAccountName};AccountKey={Outputs.storageAccountKey}" />
        <Add key="AzureWebJobsDashboard" value="DefaultEndpointsProtocol=https;AccountName={Outputs.storageAccountName};AccountKey={Outputs.storageAccountKey}" />
        <Add key="AzureStorageConnectionString" value="DefaultEndpointsProtocol=https;AccountName={Outputs.storageAccountName};AccountKey={Outputs.storageAccountKey}" />   
        <Add key="SQLAzureDatabaseEntityFrameworkConnectionString" value="{Outputs.SQLDatabaseEntityFrameworkConnectionString}" />         
        <Add key="wattTimeApiKey" value="{Inputs.WattTimeApiKeyParam}" />
		<Add key="WattTimeUsername" value="{Inputs.WattTimeUsername}" />
		<Add key="WattTimePassword" value="{Inputs.WattTimePassword}" />
		<Add key="WattTimeEmail" value="{Inputs.WattTimeEmail}" />
		<Add key="WattTimeOrganization" value="{Inputs.WattTimeOrganization}" />
        <Add key="DarkSkyApiKey" value="{Inputs.DarkSkyApiKey}" />
      </AppSettings> 
    </AzureFunctionApp>
    <Function name="prepsql" title="Preparing the SQL Database">
      <Parameters>
        <Parameter hidden="true" name="sqlConnectionString" 
          defaultValue="Server=tcp:{Outputs.sqlServer}.database.windows.net,1433;Database={Outputs.sqlDatabase};User ID={Inputs.sqlServerUsername};Password={Inputs.sqlServerPassword};Trusted_Connection=False;Encrypt=True;Connection Timeout=30" />
      </Parameters>
    </Function>
    <Manual title="Done">
      <Instructions src="Summary.md" format="markdown" />
    </Manual>
  </ProvisioningSteps>
</Template>
